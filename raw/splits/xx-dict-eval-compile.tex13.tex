====== Function MACROEXPAND, MACROEXPAND-1 ======

====Syntax====

**macroexpand {form** //\opt} env// → //expansion, expanded-p// **macroexpand-1 {form** //\opt} env// → //expansion, expanded-p//

====Arguments and Values====

//form// - a //[[CL:Glossary:form]]//.

//env// - an //[[CL:Glossary:environment]]// //[[CL:Glossary:object]]//. The default is **[[CL:Constant Variables:nil]]**.

//expansion// - a //[[CL:Glossary:form]]//.


//expanded-p// - a //[[CL:Glossary:generalized boolean]]//.


====Description====

**[[CL:Functions:macroexpand]]** and **[[CL:Functions:macroexpand-1]]** expand //[[CL:Glossary:macros]]//.


If //form// is a //[[CL:Glossary:macro form]]//, then **[[CL:Functions:macroexpand-1]]** expands the //[[CL:Glossary:macro form]]// call once.


**[[CL:Functions:macroexpand]]** repeatedly expands //form// until it is no longer a //[[CL:Glossary:macro form]]//. In effect, **[[CL:Functions:macroexpand]]** calls **[[CL:Functions:macroexpand-1]]** repeatedly until the //[[CL:Glossary:secondary value]]// it returns is **[[CL:Constant Variables:nil]]**.

If //form// is a //[[CL:Glossary:macro form]]//, then the //expansion// is a //[[CL:Glossary:macro expansion]]// and //expanded-p// is //[[CL:Glossary:true]]//. Otherwise, the //expansion// is the given //form// and //expanded-p// is //[[CL:Glossary:false]]//.


Macro expansion is carried out as follows. Once **[[CL:Functions:macroexpand-1]]** has determined that the //form// is a //[[CL:Glossary:macro form]]//, it obtains an appropriate expansion //[[CL:Glossary:function]]// for the //[[CL:Glossary:macro]]// or //[[CL:Glossary:symbol macro]]//. The value of **[[CL:Variables:*macroexpand-hook*]]** is

coerced to a //[[CL:Glossary:function]]// and

then called as a //[[CL:Glossary:function]]// of three arguments: the expansion //[[CL:Glossary:function]]//, the //form//, and the //env//. The //[[CL:Glossary:value]]// returned from this call is taken to be the expansion of the //form//.

In addition to //[[CL:Glossary:macro]]// definitions in the global environment, any local macro definitions established within //env// by \specref{macrolet} or \specref{symbol-macrolet} are considered. If only //form// is supplied as an argument, then the environment is effectively null, and only global macro definitions as established by **[[CL:Macros:defmacro]]** are considered.

//[[CL:Glossary:Macro]]// definitions are shadowed by local //[[CL:Glossary:function]]// definitions.

====Examples====

<blockquote> (defmacro alpha (x y) `(beta ,x ,y)) → ALPHA (defmacro beta (x y) `(gamma ,x ,y)) → BETA (defmacro delta (x y) `(gamma ,x ,y)) → EPSILON (defmacro expand (form &environment env) (multiple-value-bind (expansion expanded-p) (macroexpand form env) `(values ',expansion ',expanded-p))) → EXPAND (defmacro expand-1 (form &environment env) (multiple-value-bind (expansion expanded-p) (macroexpand-1 form env) `(values ',expansion ',expanded-p))) → EXPAND-1 \medbreak ;; Simple examples involving just the global environment (macroexpand-1 '(alpha a b)) → (BETA A B), //[[CL:Glossary:true]]// (expand-1 (alpha a b)) → (BETA A B), //[[CL:Glossary:true]]// (macroexpand '(alpha a b)) → (GAMMA A B), //[[CL:Glossary:true]]// (expand (alpha a b)) → (GAMMA A B), //[[CL:Glossary:true]]// (macroexpand-1 'not-a-macro) → NOT-A-MACRO, //[[CL:Glossary:false]]// (expand-1 not-a-macro) → NOT-A-MACRO, //[[CL:Glossary:false]]// (macroexpand '(not-a-macro a b)) → (NOT-A-MACRO A B), //[[CL:Glossary:false]]// (expand (not-a-macro a b)) → (NOT-A-MACRO A B), //[[CL:Glossary:false]]// \medbreak ;; Examples involving lexical environments (macrolet ((alpha (x y) `(delta ,x ,y))) (macroexpand-1 '(alpha a b))) → (BETA A B), //[[CL:Glossary:true]]// (macrolet ((alpha (x y) `(delta ,x ,y))) (expand-1 (alpha a b))) → (DELTA A B), //[[CL:Glossary:true]]// (macrolet ((alpha (x y) `(delta ,x ,y))) (macroexpand '(alpha a b))) → (GAMMA A B), //[[CL:Glossary:true]]// (macrolet ((alpha (x y) `(delta ,x ,y))) (expand (alpha a b))) → (GAMMA A B), //[[CL:Glossary:true]]// (macrolet ((beta (x y) `(epsilon ,x ,y))) (expand (alpha a b))) → (EPSILON A B), //[[CL:Glossary:true]]// (let ((x (list 1 2 3))) (symbol-macrolet ((a (first x))) (expand a))) → (FIRST X), //[[CL:Glossary:true]]// (let ((x (list 1 2 3))) (symbol-macrolet ((a (first x))) (macroexpand 'a))) → A, //[[CL:Glossary:false]]// (symbol-macrolet ((b (alpha x y))) (expand-1 b)) → (ALPHA X Y), //[[CL:Glossary:true]]// (symbol-macrolet ((b (alpha x y))) (expand b)) → (GAMMA X Y), //[[CL:Glossary:true]]// (symbol-macrolet ((b (alpha x y)) (a b)) (expand-1 a)) → B, //[[CL:Glossary:true]]// (symbol-macrolet ((b (alpha x y)) (a b)) (expand a)) → (GAMMA X Y), //[[CL:Glossary:true]]// \medbreak ;; Examples of shadowing behavior (flet ((beta (x y) (+ x y))) (expand (alpha a b))) → (BETA A B), //[[CL:Glossary:true]]// (macrolet ((alpha (x y) `(delta ,x ,y))) (flet ((alpha (x y) (+ x y))) (expand (alpha a b)))) → (ALPHA A B), //[[CL:Glossary:false]]// (let ((x (list 1 2 3))) (symbol-macrolet ((a (first x))) (let ((a x)) (expand a)))) → A, //[[CL:Glossary:false]]// </blockquote>

====Affected By====

**[[CL:Macros:defmacro]]**, **[[CL:Macros:setf]]** of **[[CL:Macros:macro-function]]**, \specref{macrolet}, \specref{symbol-macrolet}

====Exceptional Situations====

None.

====See Also====

**[[CL:Variables:*macroexpand-hook*]]**, **[[CL:Macros:defmacro]]**, **[[CL:Macros:setf]]** of **[[CL:Macros:macro-function]]**, \specref{macrolet}, \specref{symbol-macrolet}, {\secref\Evaluation}

====Notes====

Neither **[[CL:Functions:macroexpand]]** nor **[[CL:Functions:macroexpand-1]]** makes any explicit attempt to expand //[[CL:Glossary:macro forms]]// that are either //[[CL:Glossary:subforms]]// of the //form// or //[[CL:Glossary:subforms]]// of the //expansion//. Such expansion might occur implicitly, however, due to the semantics or implementation of the //[[CL:Glossary:macro function]]//.

\issue{MACROEXPAND-RETURN-VALUE:TRUE} \issue{FUNCTION-TYPE:X3J13-MARCH-88} \issue{ISO-COMPATIBILITY:ADD-SUBSTRATE}
