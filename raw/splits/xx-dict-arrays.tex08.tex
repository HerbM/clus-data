====== Function ADJUST-ARRAY ======

====Syntax====

**adjust-array** //array new-dimensions ''&key'' element-type initial-element initial-contents fill-pointer displaced-to displaced-index-offset// → //adjusted-array//

====Arguments and Values====

//array// - an //[[CL:Glossary:array]]//.

//new-dimensions// - a //[[CL:Glossary:valid array dimension]]// or a //[[CL:Glossary:list]]// of //[[CL:Glossary:valid array dimensions]]//.

//element-type// - a //[[CL:Glossary:type specifier]]//.

//initial-element// - an //[[CL:Glossary:object]]//. //Initial-element// must not be supplied if either //initial-contents// or //displaced-to// is supplied.

//initial-contents// - an //[[CL:Glossary:object]]//. If //[[CL:Glossary:array]]// has rank greater than zero, then //initial-contents// is composed of nested //[[CL:Glossary:sequences]]//, the depth of which must equal the rank of //array//. Otherwise, //[[CL:Glossary:array]]// is zero-dimensional and //initial-contents// supplies the single element. //initial-contents// must not be supplied if either //initial-element// or //displaced-to// is given.

//fill-pointer// - a //[[CL:Glossary:valid fill pointer]]// for the //[[CL:Glossary:array]]// to be created, or **[[CL:Constant Variables:t]]**, or **[[CL:Constant Variables:nil]]**. The default is **[[CL:Constant Variables:nil]]**.

//displaced-to// - an //[[CL:Glossary:array]]// or **[[CL:Constant Variables:nil]]**. //initial-elements// and //initial-contents// must not be supplied if //displaced-to// is supplied.

//displaced-index-offset// - an object of type ''(fixnum 0 n)'' where ''n'' is **[[CL:Functions:(array-total-size //displaced-to//)]]**. //displaced-index-offset// may be supplied only if //displaced-to// is supplied.

//adjusted-array// - an //[[CL:Glossary:array]]//.

====Description====

**[[CL:Functions:adjust-array]]** changes the dimensions or elements of //array//. The result is an //[[CL:Glossary:array]]// of the same //[[CL:Glossary:type]]// and rank as //array//,

that is either the modified //array//, or a newly created //[[CL:Glossary:array]]// to which //array// can be displaced, and that has the given //new-dimensions//.

//New-dimensions// specify the size of each //[[CL:Glossary:dimension]]// of //array//.

//Element-type// specifies the //[[CL:Glossary:type]]// of the //[[CL:Glossary:element|elements]]// of the resulting //[[CL:Glossary:array]]//. If //element-type// is supplied,

the consequences are unspecified if the //[[CL:Glossary:upgraded array element type]]// of //element-type// is not the same as the //[[CL:Glossary:actual array element type]]// of //array//.

If //initial-contents// is supplied, it is treated as for **[[CL:Functions:make-array]]**. In this case none of the original contents of //array// appears in the resulting //[[CL:Glossary:array]]//.

If //fill-pointer// is an //[[CL:Glossary:integer]]//, it becomes the //[[CL:Glossary:fill pointer]]// for the resulting //[[CL:Glossary:array]]//. If //fill-pointer// is the symbol **[[CL:Constant Variables:t]]**, it indicates that the size of the resulting //[[CL:Glossary:array]]// should be used as the //[[CL:Glossary:fill pointer]]//. If //fill-pointer// is **[[CL:Constant Variables:nil]]**, it indicates that the //[[CL:Glossary:fill pointer]]// should be left as it is.

If //displaced-to//

//[[CL:Glossary:non-nil]]//, a //[[CL:Glossary:displaced array]]// is created. The resulting //[[CL:Glossary:array]]// shares its contents with the //[[CL:Glossary:array]]// given by //displaced-to//. The resulting //[[CL:Glossary:array]]// cannot contain more elements than the //[[CL:Glossary:array]]// it is displaced to. If //displaced-to// is not supplied or **[[CL:Constant Variables:nil]]**, the resulting //[[CL:Glossary:array]]// is not a //[[CL:Glossary:displaced array]]//. If array ''A'' is created displaced to array ''B'' and subsequently array ''B'' is given to **[[CL:Functions:adjust-array]]**, array ''A'' will still be displaced to array ''B''. Although //array// might be a //[[CL:Glossary:displaced array]]//, the resulting //[[CL:Glossary:array]]// is not a //[[CL:Glossary:displaced array]]// unless //displaced-to// is supplied and not **[[CL:Constant Variables:nil]]**.

The interaction between **[[CL:Functions:adjust-array]]** and displaced //[[CL:Glossary:array|arrays]]// is as follows given three //[[CL:Glossary:array|arrays]]//, **[[CL:Functions:A]]**, **[[CL:Functions:B]]**, and~**[[CL:Functions:C]]**:


\itemitem{**[[CL:Functions:A]]** is not displaced before or after the call}

<blockquote> (adjust-array A ...) </blockquote>

The dimensions of **[[CL:Functions:A]]** are altered, and the contents rearranged as appropriate. Additional elements of **[[CL:Functions:A]]** are taken from //initial-element//. The use of //initial-contents// causes all old contents to be discarded.

\itemitem{**[[CL:Functions:A]]** is not displaced before, but is displaced to **[[CL:Functions:C]]** after the call}

<blockquote> (adjust-array A ... :displaced-to C) </blockquote>

None of the original contents of **[[CL:Functions:A]]** appears in **[[CL:Functions:A]]** afterwards; **[[CL:Functions:A]]** now contains the contents of **[[CL:Functions:C]]**, without any rearrangement of **[[CL:Functions:C]]**.

\itemitem{**[[CL:Functions:A]]** is displaced to **[[CL:Functions:B]]** before the call, and is displaced to **[[CL:Functions:C]]** after the call}

<blockquote> (adjust-array A ... :displaced-to B) (adjust-array A ... :displaced-to C) </blockquote>

**[[CL:Functions:B]]** and **[[CL:Functions:C]]** might be the same. The contents of **[[CL:Functions:B]]** do not appear in **[[CL:Functions:A]]** afterward unless such contents also happen to be in **[[CL:Functions:C]]** If //displaced-index-offset// is not supplied in the **[[CL:Functions:adjust-array]]** call, it defaults to zero; the old offset into **[[CL:Functions:B]]** is not retained.


\itemitem{**[[CL:Functions:A]]** is displaced to **[[CL:Functions:B]]** before the call, but not displaced afterward.}

<blockquote> (adjust-array A ... :displaced-to B) (adjust-array A ... :displaced-to nil) </blockquote> **[[CL:Functions:A]]** gets a new "data region," and contents of **[[CL:Functions:B]]** are copied into it as appropriate to maintain the existing old contents; additional elements of **[[CL:Functions:A]]** are taken from //initial-element// if supplied. However, the use of //initial-contents// causes all old contents to be discarded.




If //displaced-index-offset// is supplied, it specifies the offset of the resulting //[[CL:Glossary:array]]// from the beginning of the //[[CL:Glossary:array]]// that it is displaced to. If //displaced-index-offset// is not supplied, the offset is~0. The size of the resulting //[[CL:Glossary:array]]// plus the offset value cannot exceed the size of the //[[CL:Glossary:array]]// that it is displaced to.

If only //new-dimensions// and an //initial-element// argument are supplied, those elements of //array// that are still in bounds appear in the resulting //[[CL:Glossary:array]]//. The elements of the resulting //[[CL:Glossary:array]]// that are not in the bounds of //[[CL:Glossary:array]]// are initialized to //initial-element//; if //initial-element// is not provided,

the consequences of later reading any such new //[[CL:Glossary:element]]// of //new-array// before it has been initialized are undefined.

If //initial-contents// or //displaced-to// is supplied, then none of the original contents of //array// appears in the new //[[CL:Glossary:array]]//.

The consequences are unspecified if //array// is adjusted to a size smaller than its //[[CL:Glossary:fill pointer]]// without supplying the //fill-pointer// argument so that its //[[CL:Glossary:fill-pointer]]// is properly adjusted in the process.

If **[[CL:Functions:A]]** is displaced to **[[CL:Functions:B]]**, the consequences are unspecified if **[[CL:Functions:B]]** is adjusted in such a way that it no longer has enough elements to satisfy **[[CL:Functions:A]]**.

If **[[CL:Functions:adjust-array]]** is applied to an //[[CL:Glossary:array]]// that is //[[CL:Glossary:actually adjustable]]//, the //[[CL:Glossary:array]]// returned is //[[CL:Glossary:identical]]// to //array//.

If the //[[CL:Glossary:array]]// returned by **[[CL:Functions:adjust-array]]** is //[[CL:Glossary:distinct]]// from //array//, then the argument //array// is unchanged.


Note that if an //[[CL:Glossary:array]]// ''A'' is displaced to another //[[CL:Glossary:array]]// ''B'', and ''B'' is displaced to another //[[CL:Glossary:array]]// ''C'', and ''B'' is altered by **[[CL:Functions:adjust-array]]**, ''A'' must now refer to the adjust contents of ''B''. This means that an implementation cannot collapse the chain to make ''A'' refer to ''C'' directly and forget that the chain of reference passes through ''B''. However, caching techniques are permitted as long as they preserve the semantics specified here.

====Examples====

<blockquote> (adjustable-array-p ([[CL:Macros:defparameter]] ada (adjust-array (make-array '(2 3) :adjustable t :initial-contents '((a b c) (1 2 3))) '(4 6)))) → T (array-dimensions ada) → (4 6) (aref ada 1 1) → 2 ([[CL:Macros:defparameter]] beta (make-array '(2 3) :adjustable t)) → #2A((NIL NIL NIL) (NIL NIL NIL)) (adjust-array beta '(4 6) :displaced-to ada) → #2A((A B C NIL NIL NIL) (1 2 3 NIL NIL NIL) (NIL NIL NIL NIL NIL NIL) (NIL NIL NIL NIL NIL NIL)) (array-dimensions beta) → (4 6) (aref beta 1 1) → 2 </blockquote>

Suppose that the 4-by-4 array in ''m'' looks like this:

<blockquote> #2A(( alpha beta gamma delta ) ( epsilon zeta eta theta ) ( iota kappa lambda mu ) ( nu xi omicron pi )) </blockquote> Then the result of

<blockquote> (adjust-array m '(3 5) :initial-element 'baz) </blockquote> is a 3-by-5 array with contents

<blockquote> #2A(( alpha beta gamma delta baz ) ( epsilon zeta eta theta baz ) ( iota kappa lambda mu baz )) </blockquote>

====Affected By====

None.

====Exceptional Situations====

An error of type **[[CL:Types:error]]** is signaled if //fill-pointer// is supplied and //[[CL:Glossary:non-nil]]// but //array// has no //[[CL:Glossary:fill pointer]]//.

====See Also====

**[[CL:Functions:adjustable-array-p]]**, **[[CL:Functions:make-array]]**, **[[CL:Functions:array-dimension-limit]]**, **[[CL:Functions:array-total-size-limit]]**, **[[CL:Types:array]]**

====Notes====

None.



\issue{ARRAY-DIMENSION-LIMIT-IMPLICATIONS:ALL-FIXNUM} \issue{ADJUST-ARRAY-FILL-POINTER} \issue{ADJUST-ARRAY-DISPLACEMENT} \issue{UNINITIALIZED-ELEMENTS:CONSEQUENCES-UNDEFINED} \issue{ADJUST-ARRAY-NOT-ADJUSTABLE:IMPLICIT-COPY} \issue{ADJUST-ARRAY-NOT-ADJUSTABLE:IMPLICIT-COPY}
